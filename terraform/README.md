# Timelapse App AWS Infrastructure

This directory contains Terraform configurations to set up the AWS infrastructure required for the Timelapse mobile application.

## Resources Created

- **Amazon S3**: For storing and serving media files (images, videos)
- **Amazon Cognito**: User authentication and authorization
- **AWS AppSync**: GraphQL API for data operations
- **Amazon DynamoDB**: NoSQL database for users, posts, follows, and interactions
- **AWS Lambda**: Serverless functions for media processing
- **IAM Roles & Policies**: Secure access between services

## Prerequisites

- [Terraform](https://www.terraform.io/downloads.html) (v1.0.0+)
- [AWS CLI](https://aws.amazon.com/cli/) configured with appropriate credentials
- AWS account with permissions to create all the required resources

## Configuration

Before deploying, review and adjust the variables in `variables.tf` according to your requirements.

For development and testing, you can create a `terraform.tfvars` file:

```hcl
aws_region = "us-east-1"
app_name   = "timelapse"
environment = "dev"
```

For production deployment, create a separate file (e.g., `production.tfvars`):

```hcl
aws_region = "us-east-1"
app_name   = "timelapse"
environment = "prod"
enable_enhanced_monitoring = true
enable_waf_protection = true
```

## Deployment Instructions

### Initial Setup

1. Initialize Terraform:

```bash
terraform init
```

### Development Environment

1. Plan the deployment to see what resources will be created:

```bash
terraform plan -var-file=terraform.tfvars
```

2. Apply the configuration:

```bash
terraform apply -var-file=terraform.tfvars
```

### Production Environment

1. Plan the deployment:

```bash
terraform plan -var-file=production.tfvars
```

2. Apply the configuration:

```bash
terraform apply -var-file=production.tfvars
```

## React Native App Integration

After deploying the infrastructure, Terraform will output configuration values needed for the React Native app. 

Look for the `react_native_dotenv` output, which contains the environment variables to place in your `.env` file.

Example:

```
# AWS Configuration for Timelapse App - dev environment
# Generated by Terraform

REACT_APP_AWS_REGION=us-east-1
REACT_APP_COGNITO_USER_POOL_ID=us-east-1_abc123
REACT_APP_COGNITO_APP_CLIENT_ID=1abc123def456ghi
REACT_APP_COGNITO_IDENTITY_POOL_ID=us-east-1:aaaabbbb-cccc-dddd-eeee-ffffgggghhhh
REACT_APP_S3_BUCKET_NAME=timelapse-media-dev-abcd1234
REACT_APP_GRAPHQL_ENDPOINT=https://abcdefghij.appsync-api.us-east-1.amazonaws.com/graphql
REACT_APP_ENVIRONMENT=dev
```

Copy these values to the React Native app's `.env` file.

## Lambda Function Development

The Lambda function for media processing requires code to be uploaded. Before applying the Terraform configuration:

1. Create the Lambda function code in the `lambda` directory
2. Package the code and dependencies:

```bash
cd lambda
zip -r ../lambda/media-processor-dev.zip .
```

## State Management

By default, Terraform state is stored locally. For team environments, consider using remote state with an S3 backend and DynamoDB for state locking. Uncomment the backend configuration in `main.tf` and initialize with:

```bash
terraform init -backend-config="bucket=your-terraform-state-bucket" -backend-config="key=timelapse/terraform.tfstate" -backend-config="region=us-east-1"
```

## Cleanup

To destroy all created resources:

```bash
terraform destroy -var-file=terraform.tfvars
```

**Warning**: This will delete all resources, including data stored in DynamoDB tables and S3 buckets. Make sure to back up any important data before running this command.

## Security Considerations

- Review IAM policies to ensure least privilege
- In production, restrict CORS origins to your specific domains
- Consider enabling WAF for the AppSync API and API Gateway
- Enable CloudTrail for audit logging

## Additional Resources

- [AWS AppSync Documentation](https://aws.amazon.com/appsync/)
- [AWS SDK for JavaScript](https://docs.aws.amazon.com/sdk-for-javascript/)
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) 